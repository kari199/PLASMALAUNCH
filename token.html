<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Token Details - Plasma Launchpad</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #000;
      color: #fff;
      min-height: 100vh;
      position: relative;
    }

    /* Animated Background (same as main page) */
    .bg-animation {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: 0;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a0033 50%, #000d1a 100%);
    }

    .bg-animation::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(138, 43, 226, 0.1) 1px, transparent 1px),
                  radial-gradient(circle, rgba(0, 255, 136, 0.1) 1px, transparent 1px);
      background-size: 50px 50px, 80px 80px;
      animation: moveGrid 20s linear infinite;
    }

    @keyframes moveGrid {
      0% { transform: translate(0, 0); }
      100% { transform: translate(50px, 50px); }
    }

    .orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(40px);
      opacity: 0.5;
      animation: float 15s infinite ease-in-out;
    }

    .orb1 {
      width: 300px;
      height: 300px;
      background: linear-gradient(135deg, #8a2be2, #00ff88);
      top: 10%;
      right: 10%;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(30px, -30px) scale(1.1); }
      66% { transform: translate(-20px, 20px) scale(0.9); }
    }

    /* Main Container */
    .main-container {
      position: relative;
      z-index: 1;
      min-height: 100vh;
      padding: 20px;
    }

    /* Header */
    .header {
      max-width: 1200px;
      margin: 0 auto 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .back-btn {
      padding: 10px 20px;
      background: rgba(138, 43, 226, 0.2);
      border: 1px solid rgba(138, 43, 226, 0.5);
      border-radius: 8px;
      color: #b794f6;
      text-decoration: none;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .back-btn:hover {
      background: rgba(138, 43, 226, 0.3);
      transform: translateX(-5px);
    }

    /* Token Info Card */
    .token-card {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(15, 15, 25, 0.8);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(138, 43, 226, 0.3);
      border-radius: 24px;
      padding: 40px;
      animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Token Header */
    .token-header {
      display: flex;
      align-items: center;
      gap: 30px;
      margin-bottom: 40px;
      flex-wrap: wrap;
    }

    .token-icon {
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, #8a2be2, #00ff88);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      font-weight: bold;
      box-shadow: 0 10px 30px rgba(138, 43, 226, 0.4);
    }

    .token-title {
      flex: 1;
    }

    .token-name {
      font-size: 2.5em;
      font-weight: 800;
      background: linear-gradient(90deg, #8a2be2, #00ff88);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }

    .token-symbol {
      font-size: 1.2em;
      color: #b794f6;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: rgba(138, 43, 226, 0.1);
      border: 1px solid rgba(138, 43, 226, 0.3);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(138, 43, 226, 0.2);
    }

    .stat-label {
      color: #8b8b9f;
      font-size: 14px;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      color: #00ff88;
      font-size: 24px;
      font-weight: bold;
      word-break: break-all;
    }

    /* Trade Section */
    .trade-section {
      background: rgba(20, 20, 35, 0.6);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .trade-header {
      font-size: 1.5em;
      margin-bottom: 20px;
      color: #b794f6;
    }

    .trade-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .trade-input {
      width: 100%;
      padding: 14px 18px;
      background: rgba(15, 15, 25, 0.8);
      border: 2px solid rgba(138, 43, 226, 0.2);
      border-radius: 12px;
      color: #fff;
      font-size: 16px;
      margin-bottom: 20px;
      outline: none;
    }

    .trade-input:focus {
      border-color: #8a2be2;
      box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.1);
    }

    /* Buttons */
    .btn {
      padding: 16px 24px;
      border: none;
      border-radius: 12px;
      font-size: 16;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn-buy {
      background: linear-gradient(135deg, #00ff88, #00cc6e);
      color: #000;
    }

    .btn-buy:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0, 255, 136, 0.4);
    }

    .btn-sell {
      background: linear-gradient(135deg, #ff3b30, #ff6b6b);
      color: #fff;
    }

    .btn-sell:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(255, 59, 48, 0.4);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Price Chart Placeholder */
    .chart-container {
      background: rgba(20, 20, 35, 0.6);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #5a5a6e;
      font-size: 18px;
    }

    /* Loading */
    .loading-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(138, 43, 226, 0.3);
      border-top-color: #8a2be2;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Messages */
    .message {
      padding: 14px 18px;
      border-radius: 12px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .message.error {
      background: rgba(255, 59, 48, 0.1);
      border: 1px solid rgba(255, 59, 48, 0.3);
      color: #ff3b30;
    }

    .message.success {
      background: rgba(0, 255, 136, 0.1);
      border: 1px solid rgba(0, 255, 136, 0.3);
      color: #00ff88;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .token-card {
        padding: 20px;
      }

      .trade-buttons {
        grid-template-columns: 1fr;
      }

      .token-name {
        font-size: 1.8em;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Animated Background -->
  <div class="bg-animation">
    <div class="orb orb1"></div>
  </div>

  <!-- Main Content -->
  <div class="main-container">
    <!-- Header -->
    <div class="header">
      <a href="index.html" class="back-btn">
        <span>‚Üê</span>
        <span>Back to Launchpad</span>
      </a>
    </div>

    <!-- Loading State -->
    <div id="loadingContainer" class="loading-container">
      <div class="spinner"></div>
    </div>

    <!-- Token Content -->
    <div id="tokenContent" style="display: none;">
      <div class="token-card">
        <!-- Token Header -->
        <div class="token-header">
          <div class="token-icon" id="tokenIcon">?</div>
          <div class="token-title">
            <h1 class="token-name" id="tokenName">Loading...</h1>
            <p class="token-symbol" id="tokenSymbol">...</p>
          </div>
        </div>

        <!-- Messages -->
        <div id="errorMsg" class="message error"></div>
        <div id="successMsg" class="message success"></div>

        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Contract Address</div>
            <div class="stat-value" id="contractAddress" style="font-size: 14px;">0x...</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Supply</div>
            <div class="stat-value" id="totalSupply">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Your Balance</div>
            <div class="stat-value" id="userBalance">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Price</div>
            <div class="stat-value" id="tokenPrice">0.001 XPL</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Market Cap</div>
            <div class="stat-value" id="marketCap">0 XPL</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Holders</div>
            <div class="stat-value" id="holders">1</div>
          </div>
        </div>

        <!-- Chart Placeholder -->
        <div class="chart-container">
          üìä Price chart coming soon...
        </div>

        <!-- Trade Section -->
        <div class="trade-section">
          <h2 class="trade-header">Trade Token</h2>
          
          <input type="number" 
                 class="trade-input" 
                 id="tradeAmount" 
                 placeholder="Enter amount..."
                 min="0">
          
          <div class="trade-buttons">
            <button class="btn btn-buy" id="buyBtn" onclick="buyToken()">
              <span>üí∞</span>
              <span>Buy</span>
            </button>
            <button class="btn btn-sell" id="sellBtn" onclick="sellToken()">
              <span>üí∏</span>
              <span>Sell</span>
            </button>
          </div>

          <div style="text-align: center; color: #5a5a6e; font-size: 14px; margin-top: 10px;">
            Trading fee: 0.3% | Slippage: 1%
          </div>
        </div>

        <!-- Additional Info -->
        <div style="background: rgba(138, 43, 226, 0.1); border: 1px solid rgba(138, 43, 226, 0.3); border-radius: 16px; padding: 20px; text-align: center;">
          <p style="color: #b794f6; margin-bottom: 10px;">üöÄ This token was created on Plasma Launchpad</p>
          <p style="color: #5a5a6e; font-size: 14px;">
            Created by: <span id="creatorAddress" style="color: #8a2be2;">0x...</span>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Load ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <script>
    let provider;
    let signer;
    let tokenData;
    let tokenAddress;

    // Get token address from URL
    const urlParams = new URLSearchParams(window.location.search);
    tokenAddress = urlParams.get('address');

    window.addEventListener('load', async () => {
      console.log("Token page loaded");
      console.log("URL params:", window.location.search);
      console.log("Token address from URL:", tokenAddress);
      
      if (!tokenAddress) {
        console.error("No token address provided");
        alert("No token address provided. Redirecting to main page...");
        window.location.href = 'index.html';
        return;
      }

      // Load token data first
      const loaded = await loadTokenData();
      
      if (loaded) {
        // Only connect wallet if token data loaded successfully
        await connectWallet();
      }
    });

    async function loadTokenData() {
      const loadingContainer = document.getElementById('loadingContainer');
      const tokenContent = document.getElementById('tokenContent');

      try {
        console.log("Loading token data for:", tokenAddress);
        
        // For demo, load from localStorage
        const storageKey = `token_${tokenAddress}`;
        const storedData = localStorage.getItem(storageKey);
        
        console.log("Storage key:", storageKey);
        console.log("Stored data:", storedData);
        
        if (storedData) {
          tokenData = JSON.parse(storedData);
          console.log("Token data parsed:", tokenData);
          
          // Update UI with token data
          document.getElementById('tokenName').textContent = tokenData.name || 'Unknown Token';
          document.getElementById('tokenSymbol').textContent = tokenData.symbol || 'N/A';
          document.getElementById('tokenIcon').textContent = (tokenData.symbol || '??').substring(0, 2);
          document.getElementById('contractAddress').textContent = tokenData.address || tokenAddress;
          document.getElementById('totalSupply').textContent = parseInt(tokenData.supply || 0).toLocaleString();
          
          if (tokenData.creator) {
            document.getElementById('creatorAddress').textContent = 
              `${tokenData.creator.substring(0, 6)}...${tokenData.creator.substring(38)}`;
          }
          
          // Calculate market cap (demo values)
          const price = 0.001; // XPL per token
          const marketCap = price * parseInt(tokenData.supply || 0);
          document.getElementById('tokenPrice').textContent = `${price} XPL`;
          document.getElementById('marketCap').textContent = `${marketCap.toFixed(2)} XPL`;
          
        } else {
          // For demo purposes, create fake data if not found
          console.log("Token not found in localStorage, creating demo data...");
          
          tokenData = {
            name: "Demo Token",
            symbol: "DEMO",
            supply: "1000000",
            address: tokenAddress,
            creator: "0x0000000000000000000000000000000000000000",
            createdAt: new Date().toISOString()
          };
          
          // Update UI with demo data
          document.getElementById('tokenName').textContent = tokenData.name;
          document.getElementById('tokenSymbol').textContent = tokenData.symbol;
          document.getElementById('tokenIcon').textContent = tokenData.symbol.substring(0, 2);
          document.getElementById('contractAddress').textContent = tokenData.address;
          document.getElementById('totalSupply').textContent = parseInt(tokenData.supply).toLocaleString();
          document.getElementById('creatorAddress').textContent = "0x0000...0000";
          
          // Calculate market cap
          const price = 0.001;
          const marketCap = price * parseInt(tokenData.supply);
          document.getElementById('tokenPrice').textContent = `${price} XPL`;
          document.getElementById('marketCap').textContent = `${marketCap.toFixed(2)} XPL`;
        }

        // Show content
        loadingContainer.style.display = 'none';
        tokenContent.style.display = 'block';
        
        console.log("Token page loaded successfully");
        return true;

      } catch (err) {
        console.error("Failed to load token:", err);
        
        // Show error but don't redirect immediately
        loadingContainer.innerHTML = `
          <div style="text-align: center;">
            <p style="color: #ff3b30; margin-bottom: 20px;">Failed to load token data</p>
            <p style="color: #8b8b9f; margin-bottom: 20px;">Error: ${err.message}</p>
            <a href="index.html" class="back-btn">Back to Launchpad</a>
          </div>
        `;
        
        return false;
      }
    }

    async function connectWallet() {
      if (typeof window.ethereum !== 'undefined') {
        try {
          provider = new ethers.providers.Web3Provider(window.ethereum);
          const accounts = await window.ethereum.request({ method: 'eth_accounts' });
          
          if (accounts.length > 0) {
            signer = provider.getSigner();
            const address = await signer.getAddress();
            
            // Update user balance (demo value)
            document.getElementById('userBalance').textContent = '0';
            
            // In production, fetch actual balance from token contract
          }
        } catch (err) {
          console.log("Wallet not connected");
        }
      }
    }

    async function buyToken() {
      const amount = document.getElementById('tradeAmount').value;
      
      if (!amount || amount <= 0) {
        showError("Please enter a valid amount");
        return;
      }

      if (!signer) {
        showError("Please connect wallet first");
        window.location.href = 'index.html';
        return;
      }

      const buyBtn = document.getElementById('buyBtn');
      buyBtn.innerHTML = '<span class="spinner" style="width: 20px; height: 20px;"></span><span>Processing...</span>';
      buyBtn.disabled = true;

      try {
        // Calculate cost (demo calculation)
        const tokenPrice = 0.001; // XPL per token
        const cost = amount * tokenPrice * 1.003; // Include 0.3% fee
        
        // In production, interact with DEX contract here
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        showSuccess(`Successfully bought ${amount} ${tokenData.symbol}!`);
        
        // Update balance (demo)
        const currentBalance = parseInt(document.getElementById('userBalance').textContent.replace(/,/g, ''));
        document.getElementById('userBalance').textContent = (currentBalance + parseInt(amount)).toLocaleString();
        
      } catch (err) {
        showError("Transaction failed: " + err.message);
      } finally {
        buyBtn.innerHTML = '<span>üí∞</span><span>Buy</span>';
        buyBtn.disabled = false;
      }
    }

    async function sellToken() {
      const amount = document.getElementById('tradeAmount').value;
      
      if (!amount || amount <= 0) {
        showError("Please enter a valid amount");
        return;
      }

      if (!signer) {
        showError("Please connect wallet first");
        window.location.href = 'index.html';
        return;
      }

      const userBalance = parseInt(document.getElementById('userBalance').textContent.replace(/,/g, ''));
      
      if (amount > userBalance) {
        showError("Insufficient balance");
        return;
      }

      const sellBtn = document.getElementById('sellBtn');
      sellBtn.innerHTML = '<span class="spinner" style="width: 20px; height: 20px;"></span><span>Processing...</span>';
      sellBtn.disabled = true;

      try {
        // In production, interact with DEX contract here
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        showSuccess(`Successfully sold ${amount} ${tokenData.symbol}!`);
        
        // Update balance (demo)
        document.getElementById('userBalance').textContent = (userBalance - parseInt(amount)).toLocaleString();
        
      } catch (err) {
        showError("Transaction failed: " + err.message);
      } finally {
        sellBtn.innerHTML = '<span>üí∏</span><span>Sell</span>';
        sellBtn.disabled = false;
      }
    }

    function showError(msg) {
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.textContent = msg;
      errorMsg.style.display = 'block';
      setTimeout(() => {
        errorMsg.style.display = 'none';
      }, 5000);
    }

    function showSuccess(msg) {
      const successMsg = document.getElementById('successMsg');
      successMsg.textContent = msg;
      successMsg.style.display = 'block';
      setTimeout(() => {
        successMsg.style.display = 'none';
      }, 3000);
    }
  </script>
</body>
</html>